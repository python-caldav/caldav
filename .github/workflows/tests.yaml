---
name: tests
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
jobs:
  tests:
    name: ${{ matrix.python }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python: ${{ github.event_name == 'pull_request' && fromJSON('["3.9", "3.14"]') || fromJSON('["3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]') }}
    services:
      baikal:
        image: ckulka/baikal:nginx
        ports:
          - 8800:80
        options: >-
          --health-cmd "curl -f http://localhost/ || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 30s
      nextcloud:
        image: nextcloud:latest
        ports:
          - 8801:80
        env:
          NEXTCLOUD_ADMIN_USER: admin
          NEXTCLOUD_ADMIN_PASSWORD: admin
        options: >-
          --health-cmd "curl -f http://localhost/status.php || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 60s
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip|${{ hashFiles('setup.py') }}|${{ hashFiles('tox.ini') }}
      - run: pip install tox
      - name: Configure Baikal with pre-seeded database
        run: |
          # Copy pre-configured database and config to Baikal container
          docker cp tests/docker-test-servers/baikal/Specific/. ${{ job.services.baikal.id }}:/var/www/baikal/Specific/
          docker cp tests/docker-test-servers/baikal/config/. ${{ job.services.baikal.id }}:/var/www/baikal/config/
          # Fix permissions for SQLite
          docker exec ${{ job.services.baikal.id }} chown -R nginx:nginx /var/www/baikal/Specific /var/www/baikal/config
          docker exec ${{ job.services.baikal.id }} chmod -R 770 /var/www/baikal/Specific
          # Restart to pick up configuration
          docker restart ${{ job.services.baikal.id }}
      - name: Wait for Baikal to be ready
        run: |
          sleep 5
          timeout 60 bash -c 'until curl -f http://localhost:8800/ 2>/dev/null; do echo "Waiting..."; sleep 2; done'
          echo "Baikal is ready!"
      - name: Configure Nextcloud
        run: |
          # Wait for Nextcloud web server to be up
          echo "Waiting for Nextcloud web server..."
          timeout 60 bash -c 'until curl -f http://localhost:8801/status.php 2>/dev/null; do echo -n "."; sleep 2; done'
          echo ""
          echo "✓ Web server is up"

          # Wait for Nextcloud to be installed (first startup takes longer)
          echo "Waiting for Nextcloud to complete installation..."
          for i in {1..180}; do
            if docker exec ${{ job.services.nextcloud.id }} php occ status 2>/dev/null | grep -q "installed: true"; then
              echo "✓ Nextcloud is installed and ready"
              break
            fi
            if [ $i -eq 180 ]; then
              echo "✗ Nextcloud did not complete installation in time"
              echo "Container logs:"
              docker logs ${{ job.services.nextcloud.id }} | tail -100
              echo "Trying to run occ status:"
              docker exec ${{ job.services.nextcloud.id }} php occ status || true
              exit 1
            fi
            echo -n "."
            sleep 2
          done

          # Disable password policy
          docker exec ${{ job.services.nextcloud.id }} php occ app:disable password_policy || true

          # Create test user
          docker exec -e OC_PASS="TestPassword123!" ${{ job.services.nextcloud.id }} php occ user:add --password-from-env --display-name="Test User" testuser || echo "User may already exist"

          # Enable calendar and contacts apps
          docker exec ${{ job.services.nextcloud.id }} php occ app:enable calendar || true
          docker exec ${{ job.services.nextcloud.id }} php occ app:enable contacts || true

          # Disable rate limiting and bruteforce protection
          docker exec ${{ job.services.nextcloud.id }} php occ config:system:set ratelimit.enabled --value=false --type=boolean || true
          docker exec ${{ job.services.nextcloud.id }} php occ app:disable bruteforcesettings || true
          docker exec ${{ job.services.nextcloud.id }} php occ config:system:set auth.bruteforce.protection.enabled --value=false --type=boolean || true

          # Configure CalDAV rate limits
          docker exec ${{ job.services.nextcloud.id }} php occ config:app:set dav rateLimitCalendarCreation --value=99999 || true
          docker exec ${{ job.services.nextcloud.id }} php occ config:app:set dav maximumCalendarsSubscriptions --value=-1 || true

          # Add IP whitelist for rate limiting
          docker exec ${{ job.services.nextcloud.id }} php occ config:system:set ratelimit.whitelist.0 --value='172.17.0.0/16' || true
          docker exec ${{ job.services.nextcloud.id }} php occ config:system:set ratelimit.whitelist.1 --value='127.0.0.1' || true

          # Clear rate limit cache
          docker exec ${{ job.services.nextcloud.id }} php -r "
          \$db = new PDO('sqlite:/var/www/html/data/nextcloud.db');
          \$db->exec('DELETE FROM oc_ratelimit_entries');
          \$db->exec('DELETE FROM oc_bruteforce_attempts');
          echo 'Cleared rate limit and bruteforce caches\n';
          " || true

          echo "Nextcloud is configured!"
      - run: tox -e py
        env:
          BAIKAL_URL: http://localhost:8800
          NEXTCLOUD_URL: http://localhost:8801
  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.14"
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip|${{ hashFiles('setup.py') }}|${{ hashFiles('tox.ini') }}
      - run: pip install tox
      - run: tox -e docs
  style:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.14"
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip|${{ hashFiles('setup.py') }}|${{ hashFiles('tox.ini') }}
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit|${{ hashFiles('.pre-commit-config.yaml') }}
      - run: pip install tox
      - run: tox -e style
