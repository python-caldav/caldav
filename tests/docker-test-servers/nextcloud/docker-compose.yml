services:
  nextcloud:
    image: nextcloud:latest
    container_name: nextcloud-test
    ports:
      - "8801:80"
    environment:
      - SQLITE_DATABASE=nextcloud
      - NEXTCLOUD_ADMIN_USER=admin
      - NEXTCLOUD_ADMIN_PASSWORD=admin
      - NEXTCLOUD_TRUSTED_DOMAINS=localhost
    # Fix ownership race condition: entrypoint creates files as root,
    # but installation runs as www-data. Wrap the entrypoint to fix permissions.
    entrypoint: ["/bin/bash", "-c", "/entrypoint.sh apache2-foreground & PID=$$!; sleep 3; chown -R www-data:www-data /var/www/html/config 2>/dev/null || true; wait $$PID"]
    tmpfs:
      # Make the container truly ephemeral - data is lost on restart
      # uid/gid 33 is www-data in the Nextcloud container
      - /var/www/html:size=2g,uid=33,gid=33
